import{e as y,r as h,j as i,B as u,R as b,b as j,S as w}from"./ButtonInput-Dxec3zeE.js";function M(){const{permissions:m,dispatch:p}=y(),[f,t]=h.useState(!1),[g,c]=h.useState("");h.useEffect(()=>{(async()=>{try{t(!0);const o=await chrome.permissions.getAll(),a=[];if(o.permissions)for(const s of o.permissions)a.push({id:s,description:chrome.i18n.getMessage(`permission_${s}`)||s,revocable:!1});if(o.origins)for(const s of o.origins){let n=!0,e=chrome.i18n.getMessage(`permission_${s}`)||s;s==="https://www.google.com/*"?e=chrome.i18n.getMessage("permission_sync_clock")||s:s.includes("dropboxapi.com")?e=chrome.i18n.getMessage("permission_dropbox")||s:s.includes("googleapis.com")||s.includes("accounts.google.com")?e=chrome.i18n.getMessage("permission_drive")||s:s.includes("microsoft.com")&&(e=chrome.i18n.getMessage("permission_onedrive")||s),a.push({id:s,description:e,revocable:n})}a.sort((s,n)=>s.revocable!==n.revocable?s.revocable?1:-1:0),p({type:"setPermissions",payload:a})}catch(o){console.error("Failed to load permissions:",o),c("加载权限失败")}finally{t(!1)}})()},[p]);const v=async r=>{try{t(!0),c("");const o=m.find(s=>s.id===r);if(!o)return;if(o.validation){const n=(await Promise.all(o.validation.map(async e=>await e()))).filter(e=>!e.valid);if(n.length>0){const e=await Promise.all(n.map(async l=>l.message||"验证失败"));c(e.join(`
`)),t(!1);return}}r.startsWith("https://")?await chrome.permissions.remove({origins:[r]}):await chrome.permissions.remove({permissions:[r]}),await(async()=>{try{t(!0);const s=await chrome.permissions.getAll(),n=[];if(s.permissions)for(const e of s.permissions)n.push({id:e,description:chrome.i18n.getMessage(`permission_${e}`)||e,revocable:!1});if(s.origins)for(const e of s.origins){let l=!0,d=chrome.i18n.getMessage(`permission_${e}`)||e;e==="https://www.google.com/*"?d=chrome.i18n.getMessage("permission_sync_clock")||e:e.includes("dropboxapi.com")?d=chrome.i18n.getMessage("permission_dropbox")||e:e.includes("googleapis.com")||e.includes("accounts.google.com")?d=chrome.i18n.getMessage("permission_drive")||e:e.includes("microsoft.com")&&(d=chrome.i18n.getMessage("permission_onedrive")||e),n.push({id:e,description:d,revocable:l})}n.sort((e,l)=>e.revocable!==l.revocable?e.revocable?1:-1:0),p({type:"setPermissions",payload:n})}catch(s){console.error("Failed to load permissions:",s),c("加载权限失败")}finally{t(!1)}})(),c("权限已撤销")}catch(o){console.error("Failed to revoke permission:",o),c("撤销权限失败")}finally{t(!1)}};return i.jsxs("div",{style:{padding:"20px",maxWidth:"800px",margin:"0 auto"},children:[i.jsx("h1",{children:"权限管理"}),f&&i.jsx("div",{style:{textAlign:"center",padding:"20px"},children:i.jsx("p",{children:"加载中..."})}),g&&i.jsxs("div",{style:{backgroundColor:"#f8d7da",color:"#721c24",padding:"10px",borderRadius:"4px",marginBottom:"20px"},children:[i.jsx("p",{children:g}),i.jsx(u,{onClick:()=>c(""),className:"close-button",children:"关闭"})]}),!f&&!g&&i.jsxs("div",{children:[i.jsx("h2",{children:"当前权限"}),m.length===0?i.jsx("p",{children:"没有权限"}):i.jsx("div",{children:m.map(r=>i.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px",borderBottom:"1px solid #eee"},children:[i.jsxs("div",{style:{flex:1},children:[i.jsx("div",{style:{fontWeight:"bold"},children:r.description}),i.jsx("div",{style:{fontSize:"12px",color:"#666"},children:r.revocable?"可撤销":"必需"})]}),r.revocable&&i.jsx(u,{onClick:()=>v(r.id),className:"revoke-button",children:"撤销"})]},r.id))})]})]})}const x=document.getElementById("root");x&&b.createRoot(x).render(i.jsx(j.StrictMode,{children:i.jsx(w,{children:i.jsx(M,{})})}));
